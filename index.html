<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gate B 評価ツール（Dashboard v3）</title>
  <style>
    :root{--bg:#070a14;--card:#121a33;--muted:#93a4c7;--text:#eaf0ff;--line:#243057;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--na:#64748b;}
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,rgba(96,165,250,.22),transparent 55%),radial-gradient(1000px 700px at 90% 0%,rgba(34,197,94,.18),transparent 55%),var(--bg);color:var(--text);}

    header{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(7,10,20,.92);backdrop-filter: blur(10px);z-index:10;}
    .headbar{max-width:1100px;margin:0 auto;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    header h1{margin:0;font-size:18px;}
    header p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45;}

    .mode{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .mode .tag{color:var(--muted);font-size:11px;}
    .mode button{cursor:pointer;border:none;border-radius:12px;padding:8px 10px;color:var(--text);background:#1e2a52;font-size:12px;}
    .mode button.active{background:#2b3a6b;outline:1px solid rgba(255,255,255,.12);}

    .wrap{max-width:1100px;margin:0 auto;padding:16px;}


    .footer{max-width:1100px;margin:0 auto;padding:12px 16px 22px;color:var(--muted);font-size:11px;line-height:1.45;}
    .footer strong{color:var(--text);}

    /* default responsive */
    .grid{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;align-items:start;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 560px){.row{grid-template-columns:1fr;}}

    /* manual mode overrides */
    body[data-mode="desktop"] .grid{grid-template-columns: 1.15fr .85fr;}
    body[data-mode="mobile"] .grid{grid-template-columns:1fr;}
    body[data-mode="mobile"] .row{grid-template-columns:1fr;}

    .card{background:rgba(18,26,51,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 18px 45px rgba(0,0,0,.35);} 
    .hd{padding:14px 14px 0;}
    .hd h2{margin:0;font-size:14px;}
    .bd{padding:14px;}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(5,8,16,.55);color:var(--text);outline:none;}
    input:focus,select:focus,textarea:focus{border-color: rgba(147,164,199,.6);}    

    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.10);background:rgba(5,8,16,.4);}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;background:var(--na);}
    .good{background:var(--good)!important;} .warn{background:var(--warn)!important;} .bad{background:var(--bad)!important;} .na{background:var(--na)!important;}

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    @media (max-width: 560px){.kpi{grid-template-columns:1fr;}}
    .kpi .box{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(5,8,16,.35);} 
    .big{font-size:26px;margin-top:2px;font-weight:700;}

    .muted{color:var(--muted);font-size:12px;line-height:1.45;}

    .scoregrid{display:grid;grid-template-columns:1fr;gap:10px;}
    .score{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(5,8,16,.35);} 
    .score .top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .score .name{font-weight:650;}
    .score .sub{margin-top:6px;color:var(--muted);font-size:12px;}

    .list{margin:10px 0 0;padding-left:18px;color:var(--text);font-size:12px;line-height:1.5;}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .actions button{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;color:var(--text);background:#2b3a6b;}
    .actions button.secondary{background:#1e2a52;}

    details{border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;background:rgba(5,8,16,.25);}
    details summary{cursor:pointer;color:var(--text);font-size:12px;}

    .tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .tabs button{cursor:pointer;border:none;border-radius:999px;padding:7px 10px;color:var(--text);background:#1e2a52;font-size:12px;}
    .tabs button.active{background:#2b3a6b;outline:1px solid rgba(255,255,255,.12);}

    .howBox{margin-top:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(5,8,16,.22);padding:10px 12px;}
    .howBox ul{margin:6px 0 0;padding-left:18px;color:var(--muted);font-size:12px;line-height:1.55;}
    .howBox pre{white-space:pre-wrap;margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.6;}

    .linkbtn{background:transparent;border:1px solid rgba(255,255,255,.14);}

    /* modal */
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modalBackdrop.open{display:flex;}
    .modal{max-width:900px;width:100%;background:rgba(18,26,51,.98);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.6);}
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 14px 0;}
    .modalHead h3{margin:0;font-size:14px;}
    .modalBody{padding:14px;}
    .close{background:#1e2a52;border:none;border-radius:12px;padding:8px 10px;color:var(--text);cursor:pointer;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .ruleGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width: 720px){.ruleGrid{grid-template-columns:1fr;}}
    .ruleCard{border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(5,8,16,.22);padding:10px 12px;}
    .ruleCard h4{margin:0 0 6px;font-size:13px;}
    .ruleCard ul{margin:0;padding-left:18px;color:var(--muted);font-size:12px;line-height:1.55;}
  </style>
</head>
<body>
<header>
  <div class="headbar">
    <div>
      <h1>Gate B 評価ツール（Dashboard）</h1>
      <p>入力すると右側がリアルタイムに更新されます。PC/スマホは自動最適化（右のボタンで擬似切替も可能）。</p>
    </div>
    <div class="mode" aria-label="表示モード">
      <span class="tag">表示</span>
      <button id="modeAuto" class="active" type="button">自動</button>
      <button id="modePC" type="button">PC</button>
      <button id="modeSP" type="button">スマホ</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: Input -->
    <section class="card" aria-label="入力">
      <div class="hd"><h2>入力（Gate B）</h2></div>
      <div class="bd">
        <div class="row">
          <div>
            <label>性別（握力閾値に使用）</label>
            <select id="sex"><option value="">選択…</option><option value="M">男性</option><option value="F">女性</option></select>
          </div>
          <div>
            <label>社会的支援（総合）</label>
            <select id="support"><option value="">選択…</option><option value="ok">支援成立</option><option value="ng">不成立</option></select>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0;" />

        <div class="row">
          <div>
            <label>Katz ADL（0–6）</label>
            <input id="katz" inputmode="numeric" placeholder="例：6" />
          </div>
          <div>
            <label>Lawton ADL（0–8）</label>
            <input id="lawton" inputmode="numeric" placeholder="例：7" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>握力（kg）</label>
            <input id="grip" inputmode="decimal" placeholder="例：30" />
            <div class="muted" style="margin-top:6px;">不合格：男&lt;28 / 女&lt;18</div>
          </div>
          <div>
            <label>歩行速度（m/s）</label>
            <input id="walk" inputmode="decimal" placeholder="例：1.1" />
            <div class="muted" style="margin-top:6px;">不合格：&lt;1.0</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>TUG（秒）</label>
            <input id="tug" inputmode="decimal" placeholder="例：10.5" />
            <div class="muted" style="margin-top:6px;">不合格：≥12.0</div>
          </div>
          <div>
            <label>Mini-Cog（0–5）</label>
            <input id="minicog" inputmode="numeric" placeholder="例：4" />
            <div class="muted" style="margin-top:6px;">不合格：≤2</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>GDS-15（0–15）</label>
            <input id="gds" inputmode="numeric" placeholder="例：3" />
            <div class="muted" style="margin-top:6px;">不合格：&gt;5</div>
          </div>
          <div>
            <label>MNA-SF（0–14）</label>
            <input id="mna" inputmode="numeric" placeholder="例：12" />
            <div class="muted" style="margin-top:6px;">低栄養：≤7 / リスク：8–11</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>嚥下（MWST 0–5）</label>
            <input id="mwst" inputmode="numeric" placeholder="例：4" />
            <div class="muted" style="margin-top:6px;">合格：4–5 / 境界：3 / 不合格：≤2</div>
          </div>
          <div>
            <label>メモ（任意）</label>
            <input id="memo" placeholder="例：腹水でBMI参考不可 など" />
          </div>
        </div>

        <div class="actions">
          <button id="demoGreen" type="button">Demo: Green</button>
          <button id="demoYellow" class="secondary" type="button">Demo: Yellow</button>
          <button id="demoRed" class="secondary" type="button">Demo: Red</button>
          <button id="reset" class="secondary" type="button">Reset</button>
        </div>

        <!-- How to measure (global only) -->
        <details style="margin-top:12px;" id="howToMeasure">
          <summary>How to measure（クリックで開く：短縮→完全）</summary>
          <div class="tabs" role="tablist" aria-label="How to measure tabs">
            <button type="button" id="howShortBtn" class="active" aria-selected="true">短縮版</button>
            <button type="button" id="howFullBtn" aria-selected="false">完全版</button>
          </div>
          <div class="howBox" id="howShort">
            <div class="muted">まずはこれだけ覚えればOK（現場で迷いやすい所だけ）。</div>
            <ul>
              <li><b>歩行速度</b>：4mを「いつもの速さ」で2回、速い方を採用。</li>
              <li><b>TUG</b>：椅子→3m往復→着座まで。練習1回→本番1回。</li>
              <li><b>握力</b>：左右2回ずつ、最大値（ベスト）を採用。</li>
              <li><b>Mini-Cog</b>：3語遅延再生(0–3)＋時計描画(0 or 2)＝合計0–5。</li>
              <li><b>MWST</b>：3mL水で評価。強いむせ等は安全優先で中止。</li>
            </ul>
          </div>
          <div class="howBox" id="howFull" style="display:none;">
            <div class="muted">完全版（そのままコピペして手順書にも使える形）。</div>
            <pre>Katz ADL
普段の状態で、入浴・更衣・トイレ・移乗・排泄・食事の6項目
『自立=1』『介助=0』で採点
※肝性脳症や腹水など可逆的要因がある場合は備考に記載

Lawton ADL
電話・買い物・食事準備・家事・洗濯・移動手段・服薬管理・金銭管理の8項目
『できる=1』『できない/要支援=0』で採点

握力
姿勢：椅子座位
手順：左右各2回測定、最大値（ベスト）を採用

歩行速度
準備：床に4mの開始線・終了線をテープで示す。可能なら前後に加速/減速スペース（各1m）を確保
手順：『いつもの速さで歩いてください』。開始線を足が越えた瞬間から計時し、終了線を足が越えた瞬間で停止。2回実施し、短い時間（速い方）を採用。

TUG（Timed Up & Go）
準備：椅子と、前方3m地点の目印（テープ）を用意。
手順：『合図で立ち上がり、3m先まで歩いて回って戻り、椅子に座ってください』。『はい』で開始。座って安定した時点で停止。1回練習→本番1回。
※立ち上がり、方向転換のふらつき、歩幅、介助の要否を観察、備考に記載。

Mini-Cog
手順：①3つの単語を提示し、復唱してもらう（例：『さくら・ねこ・バス』など）。
②時計描画を依頼（例：『11時10分を示す時計を書いてください』）。
③時計描画後、先ほどの3語を思い出して言ってもらう（遅延再生）。
採点：遅延再生0-3点＋時計描画（正常=2点/異常=0点）で合計0-5点。
※肝性脳症、眠剤、睡眠不足で一時的に低下し得るため備考に記載。

GDS-15
準備：GDS-15質問票
手順：15問をYes/Noで回答（本人が読めなければ読み上げ可）。合計0–15点。

MNA-SF
準備：MNA-SF質問票
手順：摂取低下、体重減少、移動性、急性疾患/ストレス、神経心理、BMIまたは下腿周径の６項目を質問票通りに評価。合計0–14点。
※浮腫や腹水で体重/BMIが当てにならない場合は備考に記載し、下腿周径なども参考にする。

嚥下：改訂水飲みテスト（MWST）
安全：座位で実施。強いむせ、反復する誤嚥性肺炎疑い、意識低下がある場合は無理に行わない。可能ならSpO2を装着。異常があれば中止、安全第一。
手順：3mLの水を準備（シリンジ/スポイト）。『飲み込んでください』と指示し、嚥下の可否、咳込み、湿性嗄声（ガラガラ声）、呼吸状態（SpO2低下など）を観察。
評価：１点：嚥下なし、むせるand/or呼吸切迫
2点：嚥下あり、呼吸切迫
3点：嚥下あり、呼吸良好、むせるand/or湿性嗄声
4点：嚥下あり、呼吸良好、むせなし
5点：評点4に加え、反復嚥下が30秒以内に2回可能</pre>
          </div>
        </details>
      </div>
    </section>

    <!-- RIGHT: Score -->
    <aside class="card" aria-label="結果">
      <div class="hd"><h2>結果（リアルタイム）</h2></div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div class="pill" title="Overall"><span class="dot" id="dotOverall"></span><span>Overall</span></div>
              <button type="button" id="openLogic" class="linkbtn" style="padding:8px 10px;border-radius:12px;color:var(--text);">判定ロジック</button>
            </div>
            <div class="big" id="overall">—</div>
            <div class="muted" id="yellowPlan">&nbsp;</div>
          </div>
          <div class="box">
            <div class="pill"><span class="dot" id="dotRisk"></span><span>Red triggers</span></div>
            <div class="big" id="redCount">0</div>
            <div class="muted">Red条件に該当すると即Red</div>
          </div>
        </div>

        <div class="scoregrid" id="scoregrid"></div>

        <div class="score" style="margin-top:10px;">
          <div class="top"><div class="name">次の一手（Auto suggestion）</div></div>
          <ul class="list" id="nextSteps"></ul>
        </div>

        <div class="score" style="margin-top:10px;">
          <div class="top"><div class="name">判定根拠（Why?）</div></div>
          <ul class="list" id="why"></ul>
          <div class="muted" style="margin-top:6px;">※Yellowは「Green条件の未達が1–2項目」で、Redに該当しない場合。</div>
        </div>
      </div>
    </aside>

  </div>
</div>


<footer class="footer">
  <div><strong>Gate B Dashboard（完成版）</strong> / version: v3+ / updated: 2026-01-19</div>
</footer>

<!-- 判定ロジック modal -->
<div class="modalBackdrop" id="logicModal" role="dialog" aria-modal="true" aria-label="判定ロジック">
  <div class="modal">
    <div class="modalHead">
      <h3>Gate B 判定ロジック</h3>
      <button class="close" type="button" id="closeLogic">閉じる</button>
    </div>
    <div class="modalBody">
      <div class="tabs" role="tablist" aria-label="判定ロジック tabs" style="margin-top:0;">
        <button type="button" id="logicShortBtn" class="active" aria-selected="true">短縮版</button>
        <button type="button" id="logicFullBtn" aria-selected="false">完全版</button>
      </div>

      <div id="logicShort" class="ruleGrid" style="margin-top:10px;">
        <div class="ruleCard">
          <h4>Green</h4>
          <ul>
            <li>Katz=6</li>
            <li>Lawton ≥7</li>
            <li>握力（男≥28 / 女≥18）</li>
            <li>歩行速度 ≥1.0 m/s</li>
            <li>TUG &lt;12.0 秒</li>
            <li>Mini-Cog ≥3</li>
            <li>GDS-15 ≤5</li>
            <li>MNA-SF ≥12</li>
            <li>社会的支援：成立</li>
          </ul>
        </div>
        <div class="ruleCard">
          <h4>Red（いずれかで即Red）</h4>
          <ul>
            <li>Katz ≤3 または Lawton ≤3</li>
            <li>身体機能（握力/歩行/TUG）の不合格が2項目以上</li>
            <li>Mini-Cog ≤2</li>
            <li>GDS-15 &gt;5</li>
            <li>MNA-SF ≤7</li>
            <li>社会的支援：不成立</li>
          </ul>
        </div>
        <div class="ruleCard" style="grid-column:1/-1;">
          <h4>Yellow</h4>
          <ul>
            <li>Redではないが、Green条件を満たさない場合</li>
            <li>再評価目安：Yellow-2週 / Yellow-4週（下の完全版ルール参照）</li>
          </ul>
        </div>
      </div>

      <div id="logicFull" style="display:none;margin-top:10px;" class="ruleCard">
        <h4>Yellow-2週 / Yellow-4週（目安）</h4>
        <ul>
          <li><b>Yellow-2週（軽度）</b>：例）身体機能の不合格が1項目のみ（他は概ねGreen）など、短期プレハブで改善が期待できるパターン</li>
          <li><b>Yellow-4週（中等度）</b>：複数領域でGreen未達（ただしRedではない）など、介入期間を長めに見積もるパターン</li>
          <li>このツールでは、以下の簡易判定で2週/4週を表示しています：
            <ul>
              <li>mild（2週）：Katz=6 / Mini-Cog≥3 / 支援成立 を満たしつつ、①身体機能の不合格が1項目のみ（かつMNA≥12）<br/>または ②身体機能は全合格でMNAが8–11</li>
              <li>上記以外のYellowは4週目安</li>
            </ul>
          </li>
          <li>※現場運用に合わせて、ここ（2週/4週ルール）は簡単に調整できます。</li>
        </ul>
      </div>

      <div class="muted" style="margin-top:10px;">注：閾値はPDF（Gate B）準拠。MWSTは「Green条件の補助」として表示に反映（Redトリガーには含めていません）。</div>
    </div>
  </div>
</div>

<script>
  const el = (id)=>document.getElementById(id);
  const parseNum = (v)=>{const n=parseFloat(String(v||'').trim()); return Number.isFinite(n)?n:null;};
  const parseIntSafe = (v)=>{const n=parseInt(String(v||'').trim(),10); return Number.isFinite(n)?n:null;};

  function levelDot(level){return level==='good'?'good':level==='warn'?'warn':level==='bad'?'bad':'na';}

  function evaluate(){
    const sex = el('sex').value || null;
    const katz = parseIntSafe(el('katz').value);
    const lawton = parseIntSafe(el('lawton').value);
    const grip = parseNum(el('grip').value);
    const walk = parseNum(el('walk').value);
    const tug = parseNum(el('tug').value);
    const mc = parseIntSafe(el('minicog').value);
    const gds = parseIntSafe(el('gds').value);
    const mna = parseIntSafe(el('mna').value);
    const mwst = parseIntSafe(el('mwst').value);
    const support = el('support').value || null;

    const missing=[];
    const unmet=[];
    const red=[];

    // ADL
    let katzLevel=null, lawtonLevel=null;
    if(katz==null) missing.push('Katz ADL');
    else{
      katzLevel = (katz===6)?'good':(katz>=4?'warn':'bad');
      if(katz<=3) red.push('Katz ADL<=3');
      if(katz!==6) unmet.push('Katz ADLが6ではない');
    }
    if(lawton==null) missing.push('Lawton ADL');
    else{
      lawtonLevel = (lawton>=7)?'good':(lawton>=4?'warn':'bad');
      if(lawton<=3) red.push('Lawton ADL<=3');
      if(!(lawton>=7)) unmet.push('Lawton ADLが7以上ではない');
    }

    // Physical
    let gripLevel=null, walkLevel=null, tugLevel=null;
    const physFails=[];
    if(sex==null) missing.push('性別');

    if(grip==null) missing.push('握力');
    else if(!sex) gripLevel=null;
    else{
      const ok = (sex==='M') ? grip>=28 : grip>=18;
      gripLevel = ok?'good':'bad';
      if(!ok) physFails.push('握力不合格');
      if(!ok) unmet.push('握力が基準未満');
    }

    if(walk==null) missing.push('歩行速度');
    else{
      const ok = walk>=1.0;
      walkLevel = ok?'good':'bad';
      if(!ok) physFails.push('歩行速度不合格');
      if(!ok) unmet.push('歩行速度が1.0未満');
    }

    if(tug==null) missing.push('TUG');
    else{
      const ok = tug<12.0;
      tugLevel = ok?'good':'bad';
      if(!ok) physFails.push('TUG不合格');
      if(!ok) unmet.push('TUGが12秒以上');
    }

    if(physFails.length>=2) red.push('身体機能（握力/歩行速度/TUG）で不合格が2項目以上');

    // Cognition & Mood
    let mcLevel=null, gdsLevel=null;
    if(mc==null) missing.push('Mini-Cog');
    else{
      mcLevel = mc>=3?'good':'bad';
      if(mc<=2) red.push('Mini-Cog<=2');
      if(mc<3) unmet.push('Mini-Cogが3未満');
    }
    if(gds==null) missing.push('GDS-15');
    else{
      gdsLevel = gds<=5?'good':'bad';
      if(gds>5) red.push('GDS-15>5');
      if(gds>5) unmet.push('GDS-15が6以上');
    }

    // Nutrition & Swallow
    let mnaLevel=null, mwstLevel=null;
    if(mna==null) missing.push('MNA-SF');
    else{
      mnaLevel = (mna>=12)?'good':(mna>=8?'warn':'bad');
      if(mna<=7) red.push('MNA-SF<=7');
      if(mna<12) unmet.push('MNA-SFが12未満');
    }

    if(mwst==null) missing.push('MWST');
    else{
      mwstLevel = (mwst>=4)?'good':(mwst===3?'warn':'bad');
      // MWSTはRed条件に含まれていないが、Green条件（＝安全な経口）として扱う
      if(mwst<4) unmet.push('MWSTが4未満');
    }

    // Social
    let socLevel=null;
    if(support==null) missing.push('社会的支援（総合）');
    else{
      socLevel = (support==='ok')?'good':'bad';
      if(support==='ng') red.push('社会的支援不成立');
      if(support!=='ok') unmet.push('社会的支援が成立していない');
    }

    // Overall
    let overall='—';
    let yellowPlan='';

    const greenOk = (
      katz===6 && lawton!=null && lawton>=7 &&
      sex && grip!=null && walk!=null && tug!=null && gripLevel==='good' && walkLevel==='good' && tugLevel==='good' &&
      mc!=null && mc>=3 &&
      gds!=null && gds<=5 &&
      mna!=null && mna>=12 &&
      support==='ok'
    );

    // Safety: Redは即Red。それ以外で未入力があればOverallは「保留」。
    if(red.length>0) overall='Red';
    else if(missing.length>0) overall='保留';
    else if(greenOk) overall='Green';
    else overall='Yellow';

    if(overall==='Yellow'){
      // Yellow-2w vs 4w (simple rule)
      const mild = (
        katz===6 && (mc!=null && mc>=3) && support==='ok' &&
        ((physFails.length===1 && (mna==null || mna>=12)) || (mna!=null && mna>=8 && mna<=11 && physFails.length===0))
      );
      yellowPlan = mild ? 'Yellow-2週（軽度：2週プレハブ目安）' : 'Yellow-4週（4週プレハブ目安）';
    }

    return {
      inputs:{sex,katz,lawton,grip,walk,tug,mc,gds,mna,mwst,support, memo:el('memo').value||''},
      levels:{katzLevel,lawtonLevel,gripLevel,walkLevel,tugLevel,mcLevel,gdsLevel,mnaLevel,mwstLevel,socLevel},
      physFails:physFails.length,
      missing:[...new Set(missing)],
      unmet:[...new Set(unmet)],
      red:[...new Set(red)],
      overall,
      yellowPlan,
      greenOk
    };
  }

  function dotSet(id, level){
    const d=el(id); if(!d) return;
    d.classList.remove('good','warn','bad','na');
    d.classList.add(levelDot(level));
  }

  function render(){
    const ev = evaluate();

    // Overall
    dotSet('dotOverall', ev.overall==='Green'?'good':ev.overall==='Yellow'?'warn':ev.overall==='Red'?'bad':'na');
    el('overall').textContent = ev.overall;
    el('yellowPlan').textContent = (ev.overall==='Yellow') ? ev.yellowPlan : (ev.overall==='Green' ? 'Gate B Green' : (ev.overall==='Red' ? 'Gate B Red' : (ev.overall==='保留' ? '未入力あり（保留）' : '入力待ち')));

    dotSet('dotRisk', ev.red.length>0?'bad':'na');
    el('redCount').textContent = String(ev.red.length);

    // Domain cards (clean: no per-card how-to)
    const cards = [
      {name:'ADL', dot: (ev.levels.katzLevel==='bad'||ev.levels.lawtonLevel==='bad')?'bad':((ev.levels.katzLevel&&ev.levels.lawtonLevel)?((ev.levels.katzLevel==='good'&&ev.levels.lawtonLevel==='good')?'good':'warn'):null),
       sub: (ev.inputs.katz==null||ev.inputs.lawton==null)?'未入力':`Katz ${ev.inputs.katz}/6, Lawton ${ev.inputs.lawton}/8`},
      {name:'身体機能', dot: (ev.physFails>=2)?'bad':((ev.levels.gripLevel==='good'&&ev.levels.walkLevel==='good'&&ev.levels.tugLevel==='good')?'good':((ev.levels.gripLevel||ev.levels.walkLevel||ev.levels.tugLevel)?'warn':null)),
       sub: (ev.inputs.grip==null||ev.inputs.walk==null||ev.inputs.tug==null)?'未入力':`Grip ${ev.inputs.grip}kg / Walk ${ev.inputs.walk}m/s / TUG ${ev.inputs.tug}s`},
      {name:'認知', dot: ev.levels.mcLevel, sub: (ev.inputs.mc==null)?'未入力':`Mini-Cog ${ev.inputs.mc}/5`},
      {name:'気分', dot: ev.levels.gdsLevel, sub: (ev.inputs.gds==null)?'未入力':`GDS ${ev.inputs.gds}/15`},
      {name:'栄養・嚥下', dot: (ev.levels.mnaLevel==='bad'||ev.levels.mwstLevel==='bad')?'bad':((ev.levels.mnaLevel&&ev.levels.mwstLevel)?((ev.levels.mnaLevel==='good'&&ev.levels.mwstLevel==='good')?'good':'warn'):null),
       sub: `MNA ${ev.inputs.mna??'—'}/14, MWST ${ev.inputs.mwst??'—'}/5`},
      {name:'社会的支援', dot: ev.levels.socLevel, sub: (ev.inputs.support==null)?'未入力':(ev.inputs.support==='ok'?'支援成立':'不成立')}
    ];

    const grid = el('scoregrid');
    grid.innerHTML = cards.map(c=>`
      <div class="score">
        <div class="top">
          <div class="name">${c.name}</div>
          <span class="pill"><span class="dot ${levelDot(c.dot)}"></span><span>${c.dot? (c.dot==='good'?'合格':c.dot==='warn'?'要注意':'不合格'):'未入力'}</span></span>
        </div>
        <div class="sub">${c.sub}</div>
      </div>
    `).join('');

    // Why
    const why = el('why');
    const whyItems = [];
    if(ev.missing.length) whyItems.push(`未入力：${ev.missing.join(' / ')}`);
    if(ev.red.length) whyItems.push(`Red条件：${ev.red.join(' / ')}`);
    if(!ev.red.length && ev.unmet.length) whyItems.push(`Green条件未達：${ev.unmet.join(' / ')}`);
    if(ev.greenOk) whyItems.push('すべてのGreen条件を満たしています。');
    if(ev.inputs.memo) whyItems.push(`メモ：${ev.inputs.memo}`);
    why.innerHTML = whyItems.length ? whyItems.map(x=>`<li>${x}</li>`).join('') : '<li>入力すると自動表示します。</li>';

    // Next steps
    const steps = el('nextSteps');
    const s=[];
    if(ev.overall==='Red'){
      s.push('Redトリガー項目の原因が可逆的か確認（例：肝性脳症、鎮静、脱水、感染、腹水など）。');
      s.push('可逆的であればプレハブ→再評価。不可逆的なら適応再検討。');
    } else if(ev.overall==='Yellow'){
      if(ev.unmet.some(x=>x.includes('歩行速度')||x.includes('TUG')||x.includes('握力'))) s.push('身体機能：リハ/プレハブ（筋力・バランス・歩行）を優先。');
      if(ev.unmet.some(x=>x.includes('MNA'))) s.push('栄養：栄養介入（摂取量・蛋白/カロリー、サルコペニア評価）を検討。');
      if(ev.unmet.some(x=>x.includes('GDS'))) s.push('気分：うつ症状の評価・介入（睡眠、疼痛、社会的因子）を検討。');
      if(ev.unmet.some(x=>x.includes('支援'))) s.push('社会的支援：同居/通院/服薬/緊急連絡の支援体制を再構築。');
      s.push(`再評価目安：${ev.yellowPlan}`);
    } else if(ev.overall==='Green'){
      s.push('Gate BはGreen。Gate Aと合わせて総合判断へ。');
    } else {
      s.push('入力を埋めると提案が表示されます。');
    }
    steps.innerHTML = s.map(x=>`<li>${x}</li>`).join('');
  }

  // Demo buttons
  function setDemo(type){
    if(type==='Green'){
      el('sex').value='M'; el('support').value='ok';
      el('katz').value='6'; el('lawton').value='8';
      el('grip').value='30'; el('walk').value='1.1'; el('tug').value='10';
      el('minicog').value='4'; el('gds').value='2';
      el('mna').value='12'; el('mwst').value='4';
      el('memo').value='';
    }
    if(type==='Yellow'){
      el('sex').value='M'; el('support').value='ok';
      el('katz').value='6'; el('lawton').value='7';
      el('grip').value='27'; el('walk').value='1.1'; el('tug').value='10';
      el('minicog').value='4'; el('gds').value='3';
      el('mna').value='12'; el('mwst').value='4';
      el('memo').value='握力のみ軽度低下（Yellow-2週想定）';
    }
    if(type==='Red'){
      el('sex').value='F'; el('support').value='ok';
      el('katz').value='2'; el('lawton').value='2';
      el('grip').value='16'; el('walk').value='0.8'; el('tug').value='14';
      el('minicog').value='2'; el('gds').value='8';
      el('mna').value='7'; el('mwst').value='2';
      el('memo').value='複数Redトリガー（例）';
    }
    render();
  }

  function resetAll(){
    ['sex','support','katz','lawton','grip','walk','tug','minicog','gds','mna','mwst','memo'].forEach(id=>{ el(id).value=''; });
    render();
  }

  ['sex','support','katz','lawton','grip','walk','tug','minicog','gds','mna','mwst','memo'].forEach(id=>{
    el(id).addEventListener('input', render);
    el(id).addEventListener('change', render);
  });

  el('demoGreen').addEventListener('click', ()=>setDemo('Green'));
  el('demoYellow').addEventListener('click', ()=>setDemo('Yellow'));
  el('demoRed').addEventListener('click', ()=>setDemo('Red'));
  el('reset').addEventListener('click', resetAll);

  // How-to tabs
  function setHowTab(which){
    const shortBtn = el('howShortBtn');
    const fullBtn = el('howFullBtn');
    const shortBox = el('howShort');
    const fullBox = el('howFull');
    const isShort = which==='short';
    shortBtn.classList.toggle('active', isShort);
    fullBtn.classList.toggle('active', !isShort);
    shortBtn.setAttribute('aria-selected', isShort ? 'true' : 'false');
    fullBtn.setAttribute('aria-selected', !isShort ? 'true' : 'false');
    shortBox.style.display = isShort ? 'block' : 'none';
    fullBox.style.display = !isShort ? 'block' : 'none';
  }
  el('howShortBtn').addEventListener('click', ()=>setHowTab('short'));
  el('howFullBtn').addEventListener('click', ()=>setHowTab('full'));

  // Logic modal + tabs
  const modal = el('logicModal');
  function openModal(){ modal.classList.add('open'); }
  function closeModal(){ modal.classList.remove('open'); }
  el('openLogic').addEventListener('click', openModal);
  el('closeLogic').addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  function setLogicTab(which){
    const shortBtn = el('logicShortBtn');
    const fullBtn = el('logicFullBtn');
    const shortBox = el('logicShort');
    const fullBox = el('logicFull');
    const isShort = which==='short';
    shortBtn.classList.toggle('active', isShort);
    fullBtn.classList.toggle('active', !isShort);
    shortBtn.setAttribute('aria-selected', isShort ? 'true' : 'false');
    fullBtn.setAttribute('aria-selected', !isShort ? 'true' : 'false');
    shortBox.style.display = isShort ? 'grid' : 'none';
    fullBox.style.display = !isShort ? 'block' : 'none';
  }
  el('logicShortBtn').addEventListener('click', ()=>setLogicTab('short'));
  el('logicFullBtn').addEventListener('click', ()=>setLogicTab('full'));

  // Mode toggle
  function setMode(mode){
    if(mode==='auto') document.body.removeAttribute('data-mode');
    else document.body.setAttribute('data-mode', mode);
    el('modeAuto').classList.toggle('active', mode==='auto');
    el('modePC').classList.toggle('active', mode==='desktop');
    el('modeSP').classList.toggle('active', mode==='mobile');
  }
  el('modeAuto').addEventListener('click', ()=>setMode('auto'));
  el('modePC').addEventListener('click', ()=>setMode('desktop'));
  el('modeSP').addEventListener('click', ()=>setMode('mobile'));

  // initial
  render();
</script>
</body>
</html>
